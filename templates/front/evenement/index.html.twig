{% extends "front/base.html.twig" %}

{% block body %}
    {% include "front/Header.html.twig" %}

    <div class="container-fluid wow fadeInUp" data-wow-delay="0.1s">
        <div class="container">
            <div class="section-title text-center position-relative pb-3 mb-5 mx-auto" style="max-width: 600px;">
                <h5 class="fw-bold text-primary text-uppercase text-2xl">Événements</h5>
                <h1 class="mb-0 text-4xl">Liste des événements</h1>
            </div>
            <div class="row g-5">
                {% for event in evenements %}
                    <div class="col-lg-4 wow slideInUp" data-wow-delay="0.3s">
                        <div class="blog-item bg-light rounded overflow-hidden">
                            <div class="blog-img position-relative overflow-hidden">
                                <!-- Remplacez l'image par une image d'événement appropriée -->
                                <img class="img-fluid" src="{{ asset('front/img/test.png') }}" alt="">
                                <!-- Affichez le statut de l'événement, par exemple, en utilisant une couleur différente pour les événements passés ou futurs -->
                                <span class="position-absolute top-0 start-0 {{ event.statut == "ACTIVE" ? 'bg-info' : 'bg-danger' }} text-white rounded-end mt-5 py-2 px-4"
                                      href="">{{ event.statut }}</span>
                            </div>
                            <div class="p-4">
                                <div class="d-flex mb-3">
                                    <!-- Affichez les détails de l'événement, par exemple la date, le lieu, etc. -->
                                    <small class="me-3"><i class="far fa-calendar-alt text-info me-2"></i>Date
                                        : {{ event.date }}</small>
                                    <small><i class="far fa-map-marker-alt text-danger me-2"></i>Lieu : {{ event.lieu }}
                                    </small>
                                </div>
                                <h4 class="mb-3">{{ event.titre }}</h4>
                                <p>{{ event.description }}</p>
                                <!-- Ajoutez un lien pour participer ou annuler la participation à l'événement -->
                                {% if app.user %}

                                    {% if event.id in participatedEvents %}
                                        <a class="text-uppercase text-warning participation-link"
                                           data-event-id="{{ event.id }}" data-participated="true" href="#">Annuler la
                                            participation <i class="bi bi-arrow-right"></i></a>
                                    {% else %}
                                        <a class="text-uppercase text-primary participation-link"
                                           data-event-id="{{ event.id }}" data-participated="false" href="#">Participer
                                            <i class="bi bi-arrow-right"></i></a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        <div id='calendar' style="width: 1500px; height: auto; margin: 0 auto;padding-top: 100px"></div>
    </div>

    <script>
        // JavaScript pour gérer les requêtes AJAX de participation
        document.addEventListener("DOMContentLoaded", function () {
            const participationLinks = document.querySelectorAll('.participation-link');
            participationLinks.forEach(link => {
                link.addEventListener('click', function (event) {
                    event.preventDefault();
                    const eventId = this.getAttribute('data-event-id');
                    const participated = this.getAttribute('data-participated') === 'true';
                    const url = participated ? `/event/quitter/${eventId}` : `/event/participer/${eventId}`;
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({}),
                    })
                        .then(response => {
                            if (response.ok) {
                                this.textContent = participated ? 'Participer' : 'Annuler la participation';
                                this.setAttribute('data-participated', !participated);
                                this.classList.toggle('text-primary');
                                this.classList.toggle('text-warning');
                            }
                        })
                        .catch(error => {
                            // Gérer les erreurs
                            console.error('Error:', error);
                        });
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            let events = [];

            {% for event in evenements %}
            // Parse the date string into a Date object
            var startDate = new Date("{{ event.date | format('Y-m-d') }}");

            events.push({
                title: '{{ event.titre }}',
                start: startDate, // Comma was missing here
                allDay: true
            });
            {% endfor %}

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: events
            });
            calendar.render();

        });
    </script>
{% endblock %}